
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // =============================================
    // REGLAS PÚBLICAS
    // =============================================

    // Permite que cualquiera lea la configuración de la landing page.
    // La escritura sigue siendo restringida.
    match /landing_configs/{docId} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.token.role == 'superadmin';
    }

    // Permite que cualquiera lea los planes de suscripción públicos.
    // La escritura está protegida.
    match /landingPlans/{planId} {
      allow read: if resource.data.isActive == true && resource.data.isPublic == true;
      allow write: if request.auth != null && request.auth.token.role == 'superadmin';
    }

    // Permite que los usuarios lean los platos de un restaurante específico.
    match /dishes/{dishId} {
      allow read: if true;
      allow write: if request.auth != null; // Solo usuarios logueados (admin/empleado) pueden escribir.
    }
    
    // Permite a cualquiera crear una reserva.
    match /reservations/{reservationId} {
      allow create: if true;
      allow read, update, delete: if request.auth != null; // Solo usuarios logueados pueden gestionar.
    }
    
    // Permite a cualquiera leer los datos de una compañía (necesario para el menú público)
    match /companies/{companyId} {
        allow read: if true;
        allow write: if request.auth != null; // Solo usuarios logueados pueden escribir.
    }
    
    // =============================================
    // REGLAS PROTEGIDAS (Requieren autenticación)
    // =============================================

    // Los usuarios solo pueden leer/escribir su propio documento.
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      // Los superadmins pueden leer todos los usuarios.
      allow list, get: if request.auth != null && request.auth.token.role == 'superadmin';
    }

    // Los pedidos solo los puede gestionar un usuario autenticado de la compañía.
    match /orders/{orderId} {
        allow read, write: if request.auth != null; // Se podría refinar más por companyId.
        allow create: if true; // Cualquiera puede crear un pedido.
    }
    
    // Los tickets de soporte los puede crear cualquiera.
    match /supportTickets/{ticketId} {
        allow create: if true;
        allow read, write: if request.auth != null; // Solo admins pueden gestionar.
    }

    // Default: denegar todo lo demás para mayor seguridad.
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
