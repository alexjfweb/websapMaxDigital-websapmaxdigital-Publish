
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Reglas para la Landing Page Pública
    // Permite que cualquiera pueda leer la configuración principal y los planes activos.
    match /landing_configs/main {
      allow read: if true;
      allow write: if request.auth != null && request.auth.token.role == 'superadmin';
    }

    match /landingPlans/{planId} {
      allow read: if resource.data.isActive == true && resource.data.isPublic == true;
      allow write: if request.auth != null && request.auth.token.role == 'superadmin';
    }
    
    // Reglas para la Auditoría
    // Solo los superadministradores pueden leer y escribir en los logs de auditoría.
    match /planAuditLogs/{logId} {
      allow read, write: if request.auth != null && request.auth.token.role == 'superadmin';
    }
     match /globalAuditLogs/{logId} {
      allow read, write: if request.auth != null && request.auth.token.role == 'superadmin';
    }

    // Reglas para Usuarios
    // Los usuarios pueden leer su propio documento.
    // Solo los superadministradores pueden crear, actualizar o eliminar cualquier usuario.
    match /users/{userId} {
      allow read: if request.auth != null && (request.auth.uid == userId || request.auth.token.role == 'superadmin');
      allow create, update, delete: if request.auth != null && request.auth.token.role == 'superadmin';
    }

    // Reglas para Empresas (Companies)
    // Los usuarios autenticados pueden leer los datos de la empresa a la que pertenecen.
    // Solo los superadministradores pueden escribir.
    match /companies/{companyId} {
      allow read: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId;
      allow write: if request.auth != null && request.auth.token.role == 'superadmin';
    }

    // Reglas para Platos (Dishes)
    // Permite la lectura pública para menús.
    // Solo usuarios de la misma compañía (empleados, admin) pueden escribir.
    match /dishes/{dishId} {
      allow read: if true;
      allow write: if request.auth != null && request.resource.data.companyId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId;
    }

    // Reglas para Pedidos (Orders) y Reservas (Reservations)
    // Solo usuarios autenticados de la compañía pueden leer/escribir.
    match /{collection}/{docId} {
      allow read, write: if request.auth != null && 
                          (collection == 'orders' || collection == 'reservations') &&
                          request.resource.data.restaurantId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId;
    }

    // Regla de denegación por defecto para cualquier otra ruta no especificada
    match /{path=**} {
      allow read, write: if false;
    }
  }
}
