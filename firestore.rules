rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Regla para la configuración de la landing page (lectura pública)
    match /landing_configs/{configId} {
      allow read: if true;
      allow write: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'superadmin';
    }

    // Regla para los planes de la landing page (lectura pública)
    match /landingPlans/{planId} {
      allow read: if true;
      allow write: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'superadmin';
    }

    // Regla para los logs de auditoría de planes (solo superadmin)
    match /planAuditLogs/{logId} {
      allow read, write: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'superadmin';
    }
    
    // Regla para los usuarios
    match /users/{userId} {
      // Cualquiera puede crear su propio registro de usuario (registro)
      allow create: if request.auth != null && request.auth.uid == userId;
      // Los usuarios pueden leer y actualizar sus propios datos
      allow read, update: if request.auth != null && request.auth.uid == userId;
      // El superadmin puede hacer cualquier cosa
      allow read, write, delete: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'superadmin';
    }

    // Regla para las compañías
    match /companies/{companyId} {
        // El superadmin puede leer/escribir todas las compañías
        allow read, write: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'superadmin';
        // Un admin de la compañía puede leer/actualizar su propia compañía
        allow read, update: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId;
    }

    // Reglas para sub-colecciones (platos, empleados, pedidos, etc.)
    match /companies/{companyId}/{document=**} {
        // Permitir acceso si el usuario pertenece a la compañía
        allow read, write: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId;
        // O si es superadmin
        allow read, write: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'superadmin';
    }

    // Regla para pedidos (permite que cualquiera cree un pedido, pero solo los de la compañía pueden leerlos)
    match /orders/{orderId} {
        allow create: if true;
        allow read, update, delete: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == resource.data.restaurantId;
        allow read, write: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'superadmin';
    }
    
    // Regla para reservas (permite que cualquiera cree una reserva)
    match /reservations/{reservationId} {
      allow create: if true;
      allow read, update, delete: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == resource.data.restaurantId;
      allow read, write: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'superadmin';
    }
    
    // Regla para mesas y sus logs
    match /tables/{tableId}/{document=**} {
       allow read, write: if request.auth != null; // Simplificado por ahora, se puede restringir más
    }
    
    // Regla para tickets de soporte
    match /supportTickets/{ticketId} {
      allow create: if true;
      allow read, update, delete: if request.auth != null; // Simplificado
    }
    
    // Regla para la configuración de navegación (solo superadmin)
    match /configuration/main-navigation {
       allow read, write: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'superadmin';
    }
    
     // Regla para la configuración de pagos (solo superadmin)
    match /payment_methods/{docId} {
       allow read, write: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'superadmin';
    }

    // Cierra todo lo demás por defecto
    match /{path=**} {
      allow read, write: if false;
    }
  }
}
