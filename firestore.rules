rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // =================================
    // Reglas Públicas
    // Permiten lectura a cualquiera, incluso sin autenticación.
    // =================================

    // Configuración de la landing page (lectura pública)
    match /landing_configs/{docId} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.token.role == 'superadmin';
    }
    
    // Planes de suscripción (lectura pública para planes activos)
    match /landingPlans/{planId} {
      allow read: if resource.data.isActive == true && resource.data.isPublic == true;
      allow write: if request.auth != null && request.auth.token.role == 'superadmin';
    }

    // Menú de un restaurante (platos)
    match /dishes/{dishId} {
      allow read: if true;
      allow write: if request.auth != null; // Solo usuarios autenticados pueden escribir (ej. crear un plato)
    }

    // Compañías (solo lectura pública de datos no sensibles)
    match /companies/{companyId} {
        allow read: if true;
        allow write: if request.auth != null && request.auth.token.uid == companyId; // Permitir que el admin de la compañía actualice
    }

    // =================================
    // Reglas Protegidas
    // Requieren autenticación y roles específicos.
    // =================================

    // Perfiles de usuario
    match /users/{userId} {
      // Un usuario puede leer y escribir su propio perfil
      allow read, write: if request.auth != null && request.auth.uid == userId;
      // El superadmin puede leer todos los perfiles
      allow read: if request.auth != null && request.auth.token.role == 'superadmin';
    }
    
    // Pedidos (Orders)
    match /orders/{orderId} {
      // El cliente puede crear un pedido (si no está autenticado, se puede ajustar)
      allow create: if true; 
      // El admin de la compañía puede leer y actualizar los pedidos de su restaurante
      allow read, update: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == resource.data.restaurantId;
    }

    // Reservas (Reservations)
    match /reservations/{reservationId} {
      allow create: if true;
      allow read, update: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == resource.data.restaurantId;
    }

    // Mesas (Tables)
    match /tables/{tableId} {
       allow read: if true;
       allow write: if request.auth != null; // Permitir escritura a cualquier usuario autenticado
    }
    
    // Logs de auditoría (solo superadmin)
    match /globalAuditLogs/{logId} {
      allow read, write: if request.auth != null && request.auth.token.role == 'superadmin';
    }
    
    match /planAuditLogs/{logId} {
        allow read, write: if request.auth != null && request.auth.token.role == 'superadmin';
    }
    
    // Tickets de soporte
    match /supportTickets/{ticketId} {
        allow create: if true; // Cualquiera puede crear un ticket
        allow read, update: if request.auth != null; // Solo usuarios autenticados pueden leer/actualizar (simplificado)
    }
    
     // Configuración de navegación
    match /configuration/main-navigation {
        allow read: if true;
        allow write: if request.auth != null && request.auth.token.role == 'superadmin';
    }
    
    // Denegar todo lo demás por defecto
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
