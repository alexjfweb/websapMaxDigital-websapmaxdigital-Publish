rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Regla de "negar todo por defecto" para máxima seguridad.
    match /{document=**} {
      allow read, write: if false;
    }

    // =============================================
    // REGLAS PÚBLICAS (ACCESIBLES SIN AUTENTICACIÓN)
    // =============================================

    // Cualquiera puede LEER los planes de la landing page que estén activos.
    match /landingPlans/{planId} {
      allow read: if resource.data.isActive == true;
    }
    
    // Cualquiera puede LEER la configuración principal de la landing page.
    match /landing_configs/{configId} {
        allow read: if true;
    }

    // Cualquiera puede enviar una solicitud de reserva.
    match /reservations/{reservationId} {
        allow create: if true;
    }

    // =============================================
    // REGLAS PARA USUARIOS AUTENTICADOS
    // =============================================

    // Un usuario puede leer su propio documento de usuario.
    match /users/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      // La escritura se gestiona con reglas más específicas abajo.
    }
    
    // Los usuarios autenticados pueden leer los datos de la compañía a la que pertenecen.
    // La escritura se controla a nivel de endpoint/servicio para mayor seguridad.
    match /companies/{companyId} {
      allow read: if request.auth != null && request.auth.token.companyId == companyId;
    }
    
    // Reglas para colecciones anidadas dentro de una compañía
    match /companies/{companyId}/{subcollection}/{docId} {
      // Un usuario autenticado puede leer/escribir en las subcolecciones de su propia compañía.
      allow read, write: if request.auth != null && request.auth.token.companyId == companyId;
    }
    
    // Los empleados pueden leer los platos y las mesas de su compañía.
    match /dishes/{dishId} {
      allow read: if request.auth != null;
    }
    match /tables/{tableId} {
      allow read: if request.auth != null;
    }

    // Reglas para pedidos
    match /orders/{orderId} {
      // Cualquier usuario autenticado de la misma compañía puede leer o actualizar un pedido.
      allow read, update: if request.auth != null && request.resource.data.restaurantId == request.auth.token.companyId;
    }

    // =============================================
    // REGLAS PARA SUPERADMINISTRADORES (ACCESO TOTAL)
    // =============================================

    // Un superadmin puede leer y escribir en cualquier documento de cualquier colección.
    // Esta regla anula las anteriores si el usuario tiene el rol 'superadmin'.
    match /{path=**} {
      allow read, write: if request.auth != null && request.auth.token.role == 'superadmin';
    }
  }
}
