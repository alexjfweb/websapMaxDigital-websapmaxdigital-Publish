
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Reglas públicas para la landing page
    match /landing_configs/{docId} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.token.role == 'superadmin';
    }

    match /landingPlans/{planId} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.token.role == 'superadmin';
    }

    // Reglas para el menú público
    match /dishes/{dishId} {
      allow read: if true;
      // La escritura requiere que el usuario pertenezca a la compañía del plato
      allow write: if request.auth != null && request.auth.token.companyId == resource.data.companyId;
    }
    
    // Los usuarios solo pueden leer/escribir sus propios datos, excepto los superadmins
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      allow read, write: if request.auth != null && request.auth.token.role == 'superadmin';
    }

    // Las compañías solo las pueden gestionar sus admins o superadmins
    match /companies/{companyId} {
      allow read, write: if request.auth != null && (request.auth.token.companyId == companyId || request.auth.token.role == 'superadmin');
    }

    // Las demás colecciones (orders, reservations, etc.) solo son accesibles por usuarios autenticados
    // Esta es una regla general, se pueden añadir reglas más específicas si es necesario
    match /{path=**}/documents/{documentId} {
      allow read, write: if request.auth != null;
    }
  }
}
